version: "3.9"

services:
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: orchestrator
    # If you prefer using a prebuilt image instead of building locally, replace the build block with:
    # image: your-registry/orchestrator:latest
    ports:
      - "8081:8000"
    environment:
      # --- Runtime mode & logging ---
      APP_ENV: ${APP_ENV:-local}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # --- Security (set a real token for protected endpoints if applicable) ---
      BEARER_TOKEN: ${BEARER_TOKEN:-devtoken}

      # --- Upstream toggles (keep false for isolation tests) ---
      ENABLE_UPSTREAMS: ${ENABLE_UPSTREAMS:-false}

      # --- Optional upstream base URLs (ignored if ENABLE_UPSTREAMS=false) ---
      RAG_BASE_URL: ${RAG_BASE_URL:-http://localhost:8100}
      LLM_BASE_URL: ${LLM_BASE_URL:-http://localhost:8200}
      STT_BASE_URL: ${STT_BASE_URL:-ws://localhost:8700}
      TTS_BASE_URL: ${TTS_BASE_URL:-http://localhost:8800}
      ANALYTICS_BASE_URL: ${ANALYTICS_BASE_URL:-http://localhost:8900}

      # --- CORS / access (tweak for your frontend origin if needed) ---
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-*}

      # --- Service port (container) ---
      PORT: 8000
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8000/v1/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 10s
    # For quick iteration you can mount local code (uncomment next two lines).
    # volumes:
    #   - ./app:/app/app:ro
    restart: unless-stopped
